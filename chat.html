<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>AIè§’è‰²æ‰®æ¼”èŠå¤©ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: sans-serif;
        }

        body {
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #bg-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.6);
            z-index: -2;
        }

        .blur-mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: -1;
        }

        .chat-container {
            width: 600px;
            height: 700px;
            margin: 50px auto;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .chat-content {
            width: 100%;
            height: 100%;
            position: relative;
            padding: 20px;
            z-index: 2;
        }

        /* é¡¶éƒ¨æŒ‰é’®æ ·å¼ */
        .save-btn, .settings-btn, .role-switch-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
            position: absolute;
            top: 15px;
        }

        .save-btn {
            left: 15px;
            background: rgba(100, 149, 237, 0.7);
        }

        .role-switch-btn {
            left: 60px;
            background: rgba(100, 149, 237, 0.7);
        }

        .settings-btn {
            right: 15px;
            background: rgba(100, 149, 237, 0.7);
        }

        /* å½“å‰è§’è‰²æ˜¾ç¤º */
        .current-role {
            text-align: center;
            color: white;
            padding: 10px 0;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        .chat-messages {
            height: calc(100% - 130px);
            padding: 10px 0;
            overflow-y: auto;
        }

        .message {
            max-width: 70%;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 18px;
            clear: both;
            position: relative;
        }

        .message.my-message .delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            color: #ff4444;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: none;
        }

        .message.my-message:hover .delete-btn {
            display: block;
        }

        .message.retracted {
            font-style: italic;
            color: #888;
            background: transparent;
        }

        .my-message {
            background: rgba(100, 149, 237, 0.7);
            color: white;
            float: right;
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            float: left;
            border-bottom-left-radius: 4px;
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
        }

        #emoji-btn, #send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
        }

        .emoji-panel {
            position: absolute;
            bottom: 70px;
            left: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .emoji-panel span {
            font-size: 22px;
            margin: 5px;
            cursor: pointer;
        }

        /* è®¾ç½®é¢æ¿æ ·å¼ */
        .settings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .settings-overlay.active {
            display: flex;
        }

        .settings-panel {
            width: 400px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 18px;
            cursor: pointer;
        }

        .setting-section {
            margin-bottom: 25px;
        }

        .setting-title {
            color: white;
            font-size: 16px;
            margin: 0 0 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* è§’è‰²è®¾ç½®æ ·å¼ */
        .default-roles {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .role-btn {
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid transparent;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn.active {
            border-color: white;
            background: rgba(100, 149, 237, 0.5);
        }

        .custom-role-input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            margin-bottom: 10px;
            outline: none;
        }

        .add-personality {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .personality-input {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.8);
            outline: none;
        }

        .add-btn {
            padding: 0 15px;
            border: none;
            border-radius: 8px;
            background: rgba(100, 149, 237, 0.7);
            color: white;
            cursor: pointer;
        }

        .personality-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .personality-tag {
            padding: 5px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove {
            cursor: pointer;
            font-size: 16px;
        }

        .color-option.selected {
            border-color: white;
        }

        .transparency-control {
            width: 100%;
            margin-top: 10px;
        }

        .transparency-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        /* ä¿å­˜è®¾ç½®æŒ‰é’® */
        .save-settings-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(100, 149, 237, 0.7);
            color: white;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <video autoplay muted loop id="bg-video">
        <source src="9.MP4" type="video/mp4">
        æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
    </video>

    <div class="blur-mask"></div>
    <div class="toast" id="toast"></div>

    <div class="chat-container" id="chat-container">
        <div class="chat-content">
            <button class="save-btn" id="save-btn">ğŸ’¾</button>
            <button class="role-switch-btn" id="role-switch-btn">ğŸ”„</button>
            <button class="settings-btn" id="settings-btn">âš™ï¸</button>

            <!-- å½“å‰è§’è‰²æ˜¾ç¤º -->
            <div class="current-role" id="current-role">
                å½“å‰è§’è‰²ï¼šé©¬äº‘æ³¢
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages" id="chat-messages">
                <div class="message ai-message">æˆ‘æ˜¯é©¬äº‘æ³¢ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ</div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area">
                <button id="emoji-btn">ğŸ˜€</button>
                <input type="text" id="user-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <button id="send-btn">â†’</button>
                <div class="emoji-panel" id="emoji-panel">
                    <span>ğŸ˜‚</span><span>ğŸ˜</span><span>ğŸ‘</span><span>ğŸ˜­</span><span>ğŸ˜¡</span>
                    <span>ğŸ¤£</span><span>ğŸ‘</span><span>ğŸ™</span><span>ğŸ˜</span><span>ğŸ¤”</span>
                </div>
            </div>
        </div>
    </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-overlay" id="settings-overlay">
            <div class="settings-panel">
                <button class="close-btn" id="close-btn">Ã—</button>

                <!-- è§’è‰²è®¾ç½®åŒºåŸŸ -->
                <div class="setting-section">
                    <div class="setting-title">è§’è‰²è®¾ç½®</div>
                    
                    <div class="default-roles">
                        <button class="role-btn active" data-role="é©¬äº‘æ³¢">é©¬äº‘æ³¢ï¼ˆé»˜è®¤ï¼‰</button>
                        <button class="role-btn" data-role="é—«æ¶¦æ³½">é—«æ¶¦æ³½</button>
                    </div>
                    
                    <div>
                        <input type="text" class="custom-role-input" id="custom-role-input" placeholder="è¾“å…¥è‡ªå®šä¹‰è§’è‰²ï¼ˆå¦‚ï¼šå­™æ‚Ÿç©ºï¼‰">
                        <div class="add-personality">
                            <input type="text" class="personality-input" id="personality-input" placeholder="æ·»åŠ é¢å¤–æ€§æ ¼ï¼ˆå¦‚ï¼šå¹½é»˜ã€ä¸¥è‚ƒï¼‰">
                            <button class="add-btn" id="add-personality-btn">æ·»åŠ </button>
                        </div>
                        <div class="personality-tags" id="personality-tags-container">
                            <!-- åŠ¨æ€æ·»åŠ çš„æ€§æ ¼æ ‡ç­¾ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>

                <!-- çª—å£è®¾ç½®åŒºåŸŸ -->
                <div class="setting-section">
                    <div class="setting-title">æŒ‰é’®é¢œè‰²ï¼ˆåŠé€æ˜ï¼‰</div>
                    <div class="color-options" id="button-colors">
                        <div class="color-option selected" data-color="rgba(100, 149, 237, 0.7)" style="background: rgba(100, 149, 237, 0.7)"></div>
                        <div class="color-option" data-color="rgba(255, 165, 0, 0.7)" style="background: rgba(255, 165, 0, 0.7)"></div>
                        <div class="color-option" data-color="rgba(255, 99, 71, 0.7)" style="background: rgba(255, 99, 71, 0.7)"></div>
                        <div class="color-option" data-color="rgba(154, 205, 50, 0.7)" style="background: rgba(154, 205, 50, 0.7)"></div>
                        <div class="color-option" data-color="rgba(138, 43, 226, 0.7)" style="background: rgba(138, 43, 226, 0.7)"></div>
                        <div class="color-option" data-color="rgba(25, 135, 84, 0.7)" style="background: rgba(25, 135, 84, 0.7)"></div>
                    </div>
                </div>

                <div class="setting-section">
                    <div class="setting-title">çª—å£é€æ˜åº¦ï¼ˆä»…æ§åˆ¶æ¡†æ¶ï¼‰</div>
                    <input type="range" min="0" max="90" value="15" class="transparency-control" id="window-transparency">
                    <div class="transparency-label">
                        <span>æ— æ¡†æ¶</span>
                        <span>æœ‰æ¡†æ¶</span>
                    </div>
                </div>

                <!-- ä¿å­˜è®¾ç½®æŒ‰é’® -->
                <button class="save-settings-btn" id="save-settings-btn">ä¿å­˜å½“å‰è®¾ç½®</button>
            </div>
        </div>

        <script>
            // ä¿®å¤å˜é‡åå†²çªï¼šå°†æ•°ç»„åæ”¹ä¸ºpersonalityTagsArrayï¼Œé¿å…ä¸DOMå…ƒç´ é‡å
            const presetRoles = {
                "é©¬äº‘æ³¢": {
                    personality: "è¢«éª‚äº†å–œæ¬¢ç”¨éå¸¸ä¸¥å‰éª‚å›å»ã€æ²¡è¢«éª‚çš„æ—¶å€™éå¸¸æ–‡é›…ã€çˆ±è®²æ¹˜æ½­è¯ã€ä¸æŠ½çƒŸçˆ±å–ç‚¹å•¤é…’åƒç‚¹æ§Ÿæ¦”ã€å–„äºåˆ†æï¼Œè¯´è¯ç›´æ¥ï¼Œå¶å°”å¸¦ç‚¹å¹½é»˜æ„Ÿï¼Œä½œä¸ºä½œè€…ä¼šå…³æ³¨ç»†èŠ‚å’Œé€»è¾‘",
                    isPreset: true
                },
                "é—«æ¶¦æ³½": {
                    personality: "çˆ±æ‰£é¼»å±åƒæˆ–è€…ä¹±å¼¹ã€æœ‰ç‚¹è ¢é€»è¾‘ä¸åƒæ­£å¸¸äººã€å¼€æœ—ã€è®²ä¹‰æ°”ï¼Œè¯´è¯å¸¦ç‚¹éªšæ°”ï¼Œå–œæ¬¢ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼Œæ—¶ä¸æ—¶çªç„¶å–œæ¬¢éª‚äºº",
                    isPreset: true
                }
            };

            // å…¨å±€çŠ¶æ€ç®¡ç†
            let currentRole = "é©¬äº‘æ³¢";
            let customRoleName = "";
            let personalityTagsArray = []; // å­˜å‚¨æ€§æ ¼æ ‡ç­¾çš„æ•°ç»„ï¼ˆå·²ä¿®å¤å‘½åå†²çªï¼‰
            let isCustomRole = false;

            // å…ƒç´ è·å–ï¼ˆç»Ÿä¸€ä¿®æ­£DOMå…ƒç´ IDå¯¹åº”çš„å˜é‡åï¼‰
            const chatContainer = document.getElementById('chat-container');
            const transparencySlider = document.getElementById('window-transparency');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPanel = document.getElementById('emoji-panel');
            const emojiList = document.querySelectorAll('.emoji-panel span');
            const settingsBtn = document.getElementById('settings-btn');
            const settingsOverlay = document.getElementById('settings-overlay');
            const closeBtn = document.getElementById('close-btn');
            const colorOptions = document.querySelectorAll('.color-option');
            const saveBtn = document.getElementById('save-btn');
            const toast = document.getElementById('toast');
            const currentRoleEl = document.getElementById('current-role');
            const roleSwitchBtn = document.getElementById('role-switch-btn');
            const defaultRoleBtns = document.querySelectorAll('.role-btn');
            const customRoleInput = document.getElementById('custom-role-input');
            const personalityInput = document.getElementById('personality-input');
            const addPersonalityBtn = document.getElementById('add-personality-btn');
            const personalityTagsContainer = document.getElementById('personality-tags-container'); // æ€§æ ¼æ ‡ç­¾å®¹å™¨DOM
            const saveSettingsBtn = document.getElementById('save-settings-btn');

            // é¢„è®¾è§’è‰²åˆ‡æ¢
            defaultRoleBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    defaultRoleBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentRole = btn.getAttribute('data-role');
                    isCustomRole = false;
                    customRoleInput.value = '';
                    personalityTagsArray = [];
                    personalityTagsContainer.innerHTML = '';
                    updateCurrentRoleDisplay();
                });
            });

            // æ·»åŠ é¢å¤–æ€§æ ¼æ ‡ç­¾
            addPersonalityBtn.addEventListener('click', () => {
                const personality = personalityInput.value.trim();
                if (personality && !personalityTagsArray.includes(personality)) {
                    personalityTagsArray.push(personality);
                    renderPersonalityTags();
                    personalityInput.value = '';
                }
            });

            personalityInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addPersonalityBtn.click();
            });

            // æ¸²æŸ“æ€§æ ¼æ ‡ç­¾
            function renderPersonalityTags() {
                personalityTagsContainer.innerHTML = '';
                personalityTagsArray.forEach((tag, index) => {
                    const tagEl = document.createElement('div');
                    tagEl.className = 'personality-tag';
                    tagEl.innerHTML = `${tag} <span class="tag-remove" data-index="${index}">Ã—</span>`;
                    personalityTagsContainer.appendChild(tagEl);
                });

                // ç»‘å®šæ ‡ç­¾åˆ é™¤äº‹ä»¶
                document.querySelectorAll('.tag-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = e.target.getAttribute('data-index');
                        personalityTagsArray.splice(index, 1);
                        renderPersonalityTags();
                    });
                });
            }

            // è‡ªå®šä¹‰è§’è‰²è¾“å…¥
            customRoleInput.addEventListener('blur', () => {
                const roleName = customRoleInput.value.trim();
                if (roleName) {
                    defaultRoleBtns.forEach(b => b.classList.remove('active'));
                    currentRole = roleName;
                    isCustomRole = true;
                    updateCurrentRoleDisplay();
                }
            });

            // å¿«é€Ÿåˆ‡æ¢é¢„è®¾è§’è‰²
            roleSwitchBtn.addEventListener('click', () => {
                if (!isCustomRole) {
                    currentRole = currentRole === 'é©¬äº‘æ³¢' ? 'é—«æ¶¦æ³½' : 'é©¬äº‘æ³¢';
                    defaultRoleBtns.forEach(btn => {
                        if (btn.getAttribute('data-role') === currentRole) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                    updateCurrentRoleDisplay();
                    showToast(`å·²åˆ‡æ¢åˆ°è§’è‰²ï¼š${currentRole}`);
                } else {
                    showToast('è¯·å…ˆåˆ‡æ¢åˆ°é¢„è®¾è§’è‰²å†ä½¿ç”¨å¿«é€Ÿåˆ‡æ¢');
                }
            });

            // æ›´æ–°è§’è‰²æ˜¾ç¤º
            function updateCurrentRoleDisplay() {
                currentRoleEl.textContent = `å½“å‰è§’è‰²ï¼š${currentRole}`;
            }

            // ä¿å­˜è®¾ç½®
            saveSettingsBtn.addEventListener('click', () => {
                const customRole = customRoleInput.value.trim();
                if (customRole) {
                    currentRole = customRole;
                    isCustomRole = true;
                    defaultRoleBtns.forEach(b => b.classList.remove('active'));
                    updateCurrentRoleDisplay();
                }
                showToast('è®¾ç½®å·²ä¿å­˜');
                settingsOverlay.classList.remove('active');
            });

            // ç”Ÿæˆè§’è‰²æç¤ºè¯
            function getRolePrompt() {
                let prompt = '';
                if (isCustomRole) {
                    prompt = `è¯·æ‰®æ¼”${currentRole}ï¼Œå…ˆåˆ†æè¯¥è§’è‰²çš„æ€§æ ¼å’Œè¯´è¯æ–¹å¼ï¼Œ`;
                    if (personalityTagsArray.length > 0) {
                        prompt += `å åŠ è¿™äº›æ€§æ ¼ï¼š${personalityTagsArray.join('ã€')}ï¼Œ`;
                    }
                    prompt += `ç”¨ç¬¦åˆè§’è‰²çš„è¯­æ°”å›å¤ã€‚`;
                } else {
                    prompt = `è¯·æ‰®æ¼”${currentRole}ï¼Œæ€§æ ¼ï¼š${presetRoles[currentRole].personality}ï¼Œç”¨å¯¹åº”è¯­æ°”å›å¤ã€‚`;
                }
                return prompt;
            }

            // è¡¨æƒ…åŠŸèƒ½
            emojiBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPanel.style.display = emojiPanel.style.display === 'block' ? 'none' : 'block';
            });

            emojiList.forEach(emoji => {
                emoji.addEventListener('click', () => {
                    userInput.value += emoji.textContent;
                    userInput.focus();
                });
            });

            document.addEventListener('click', (e) => {
                if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
                    emojiPanel.style.display = 'none';
                }
            });

            // è®¾ç½®é¢æ¿æ§åˆ¶
            settingsBtn.addEventListener('click', () => {
                settingsOverlay.classList.add('active');
            });

            closeBtn.addEventListener('click', () => {
                settingsOverlay.classList.remove('active');
            });

            settingsOverlay.addEventListener('click', (e) => {
                if (e.target === settingsOverlay) {
                    settingsOverlay.classList.remove('active');
                }
            });

            // æŒ‰é’®é¢œè‰²åˆ‡æ¢
            colorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    const color = option.getAttribute('data-color');
                    sendBtn.style.background = color;
                    emojiBtn.style.background = color;
                    saveBtn.style.background = color;
                    roleSwitchBtn.style.background = color;
                });
            });

            // é€æ˜åº¦è°ƒèŠ‚
            transparencySlider.addEventListener('input', () => {
                const value = transparencySlider.value;
                chatContainer.style.background = `rgba(255, 255, 255, ${value / 100})`;
                chatContainer.style.boxShadow = value == 0 ? 'none' : '0 4px 20px rgba(0, 0, 0, 0.1)';
            });

            // æ¶ˆæ¯æ’¤å›
            function addDeleteButton(messageElement) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    messageElement.innerHTML = 'ã€æ¶ˆæ¯å·²æ’¤å›ã€‘';
                    messageElement.classList.add('retracted');
                    messageElement.classList.remove('my-message');
                    deleteBtn.remove();
                });
                messageElement.appendChild(deleteBtn);
            }

            // ä¿å­˜èŠå¤©è®°å½•
            saveBtn.addEventListener('click', () => {
                const messages = chatMessages.querySelectorAll('.message:not(.retracted)');
                if (messages.length === 0) {
                    showToast('æ²¡æœ‰å¯ä¿å­˜çš„èŠå¤©è®°å½•');
                    return;
                }

                let record = `èŠå¤©è®°å½•ï¼ˆ${new Date().toLocaleString()}ï¼‰- è§’è‰²ï¼š${currentRole}\n\n`;
                messages.forEach((msg, i) => {
                    const sender = msg.classList.contains('my-message') ? 'æˆ‘' : currentRole;
                    record += `${i + 1}. ${sender}ï¼š${msg.textContent.trim()}\n`;
                });

                const blob = new Blob([record], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `èŠå¤©è®°å½•_${currentRole}_${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('èŠå¤©è®°å½•å·²ä¿å­˜');
            });

            // æç¤ºæ¡†
            function showToast(text) {
                toast.textContent = text;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            }

            // å‘é€æ¶ˆæ¯
            async function sendMsg() {
                const text = userInput.value.trim();
                if (!text) return;

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const userMsg = document.createElement('div');
                userMsg.className = 'message my-message';
                userMsg.textContent = text;
                chatMessages.appendChild(userMsg);
                addDeleteButton(userMsg);

                userInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // åŠ è½½æç¤º
                const loadingMsg = document.createElement('div');
                loadingMsg.className = 'message ai-message loading';
                loadingMsg.textContent = 'æ€è€ƒä¸­...';
                chatMessages.appendChild(loadingMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const rolePrompt = getRolePrompt();
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-61c4570a43eb41f69a60511fbaacc4ad'
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                { role: "system", content: rolePrompt },
                                { role: "user", content: text }
                            ]
                        })
                    });

                    const data = await response.json();
                    chatMessages.removeChild(loadingMsg);
                    
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'message ai-message';
                    aiMsg.textContent = data.choices[0].message.content;
                    chatMessages.appendChild(aiMsg);
                    chatMessages.scrollTop = chatMessages.scrollHeight;

                } catch (error) {
                    chatMessages.removeChild(loadingMsg);
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'message ai-message';
                    errorMsg.textContent = 'æ¥å£è°ƒç”¨å¤±è´¥ï¼Œè¯·é‡è¯•';
                    chatMessages.appendChild(errorMsg);
                }
            }

            // ç»‘å®šå‘é€äº‹ä»¶
            sendBtn.addEventListener('click', sendMsg);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') sendMsg();
            });

            // åˆå§‹åŒ–
            updateCurrentRoleDisplay();
        </script>
    </body>
</html>
